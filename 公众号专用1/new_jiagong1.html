<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<title>新建加工单</title>
		<link rel="stylesheet" href="css/layui.css">
		<link rel="stylesheet" type="text/css" href="css/layui.mobile.css" />
		<link rel="stylesheet" type="text/css" href="css/publicNum.css" />
		<style>
			html,body{
				height: 100%;
			}
			body {
				background-color: #E5E5E5;
			}
			.container{
				height: calc(100% - 40px);
				overflow: auto;
			}
			.baseMsg {
				background-color: white;
				padding: 5px;
				padding-top: 20px;
			}
			
			.baseMsg label {
				padding-left: 0;
				padding-right: 10px;
			}
			
			.layui-form-item .layui-input-block.w200 {
				width: 200px;
			}
			
			.baseMsg .layui-form-item {
				margin-bottom: 10px;
			}
			
			.p9 {
				padding: 9px 0;
			}
			
			.layui-form-item .layui-input-block {
				margin-left: 90px;
			}
			
			.title {
				text-align: center;
				font-size: 16px;
				line-height: 36px;
				font-weight: 900;
				padding-top: 5px;
			}
			
			.dingpeidan {
				margin-top: 10px;
				background-color: #fff;
			}
			
			.dingpeidan .layui-table th,
			.dingpeidan .layui-table td {
				padding: 10px 0;
				text-align: center;
				min-width: 30px;
			}
			
			.userType ul {
				text-align: center;
			}
			
			.userType ul li {
				display: inline-block;
				padding: 5px 10px;
				margin: 0px 10px;
				width: 80px;
				box-sizing: border-box;
				border: 1px solid #25A9E1;
				color: #25A9E1;
				border-radius: 5px;
			}
			
			.userType ul li.userTypeCheck {
				background-color: #25A9E1;
				color: white;
			}
			
			.jingpianMsg {
				margin-top: 10px;
				background-color: #fff;
			}
			
			.sconedTitle {
				color: #25A9E1;
				font-weight: 900;
				text-align: center;
				font-family: "microsoft yahei";
			}
			
			.glassImgDetail li {
				width: 50%;
				float: left;
			}
			
			.glassImgDetail li img {
				width: 150px;
				height: 150px;
				display: block;
				margin: 10px auto;
			}
			
			.jpArgs {
				padding: 7px 10px;
			}
			
			.jpArgs1 {
				padding: 11px;
			}
			
			.choseSrouce {
				text-align: center;
				padding: 10px 0px;
			}
			
			.definBtn {
				padding: 7px 10px;
				display: inline-block;
				width: 100px;
				border: 1px solid #25A9E1;
				color: #25A9E1;
				margin: 5px 10px;
				border-radius: 4px;
			}
			
			.choseSrouce .check {
				color: white;
				background-color: #25A9E1;
			}
			
			.jpDetails {
				margin-bottom: 10px;
			}
			
			.jingjiaMsg {
				margin-top: 10px;
				background-color: #fff;
			}
			
			.jingjiaChose {
				width: 300px;
				margin: 0 auto;
			}
			
			.jingjiaChose li {
				float: left;
				width: 33.333%;
				height: 100px;
			}
			
			.jingjiaChose li img {
				height: 80px;
				width: 80px;
				display: block;
				margin: 10px auto;
			}
			
			.gongyi {
				margin-top: 10px;
				background-color: #fff;
			}
			
			.gongyi .icon {
				background: url(img/off_btn.png) no-repeat 0 0;
				background-size: 100% 100%;
				display: inline-block;
				height: 22.4px;
				width: 35px;
				vertical-align: middle;
				margin: 0px 8px;
				margin-top: -2px;
			}
			
			.gongyi .iconCheck {
				background: #fff url(img/onblueBtn.png) 0 0px no-repeat;
				background-size: 100% 100%;
			}
			
			.checkMain {
				float: left;
				height: 38px;
				line-height: 38px;
				position: absolute;
				left: 10px;
				top: 0px;
				color: #25A9E1;
				font-weight: 900;
				text-align: right;
				width: 115px;
			}
			
			.gongyi .details {
				float: left;
				height: 38px;
			}
			
			.gongyiList>li {
				overflow: hidden;
				padding-left: 120px;
				position: relative;
			}
			
			.gongyiList .gongyiInput {
				float: left;
				width: 40px;
				height: 26px;
				margin-top: 4px;
				margin-left: 5px;
			}
			
			.gongyiList .showPrice {
				float: left;
				height: 38px;
				font-size: 12px;
				line-height: 38px;
				margin-left: 10px;
				margin-right: 20px;
				color: orange;
			}
			
			.gongyiList .smallIconUncheck {
				display: inline-block;
				background: url(./img/nocheck_icon.png) no-repeat 0 0;
				background-size: 100% 100%;
				width: 20px;
				height: 20px;
				vertical-align: middle;
				margin: 0px 5px;
			}
			
			.gongyiList .smallIconCheck {
				background: url(./img/check_icon.png) no-repeat 0 0;
				background-size: 100% 100%;
			}
			
			.gongyiList .moxing {
				height: 38px;
				line-height: 38px;
				float: left;
			}
			
			.gongyiList .moxingText {
				/*padding-left: 10px;*/
			}
			
			.gongyi .layui-unselect {
				float: left;
			}
			
			.otherReq {
				margin-top: 10px;
				background-color: #fff;
			}
			
			.otherReq .checkRL {
				width: 150px;
				height: 38px;
				line-height: 38px;
				border: 1px solid #25A9E1;
				border-radius: 4px;
				margin: 0 auto;
				text-align: center;
			}
			
			.otherReq .checkRL .jingjiaR,
			.otherReq .checkRL .jingjiaL {
				width: 50%;
				float: left;
				height: 38px;
				line-height: 38px;
				color: #25A9E1;
			}
			
			.otherReq .checkRL .jingjiaR.check {
				background-color: #25A9E1;
				border-top-left-radius: 4px;
				border-bottom-left-radius: 4px;
				color: white;
			}
			
			.otherReq .checkRL .jingjiaL.check {
				background-color: #25A9E1;
				border-top-right-radius: 4px;
				border-bottom-right-radius: 4px;
				color: white;
			}
			
			.otherReq .layui-form-item .layui-input-block {
				margin-left: 70px;
			}
			
			.otherReq .jingjiaArgs {
				margin-top: 20px;
				position: relative;
			}
			
			.otherReq .jingjiaArgs .layui-form-item .layui-form-label {
				padding: 5px;
				width: 60px;
			}
			
			.otherReq .jingjiaArgs .layui-form-item .layui-input {
				width: 90px;
			}
			
			.otherReq .jingjiaArgs li {
				float: left;
				width: 50%;
				box-sizing: border-box;
			}
			
			.otherReq .jingjiaArgs:before {
				content: '';
				height: 90%;
				border-left: 1px solid #ccc;
				position: absolute;
				left: 49%;
			}
			
			.beizhu {
				padding-left: 60px;
				padding-right: 20px;
				position: relative;
			}
			
			.beizhu textarea {
				resize: none;
			}
			
			.beizhu .beizhuMark {
				position: absolute;
				left: 10px;
				top: 5px;
			}
			
			.fr {
				float: right;
			}
			
			.fl {
				float: left;
			}
			
			.allPrice {
				background-color: #fff;
				padding: 10px 0;
				text-align: right;
				padding-right: 20px;
			}
			
			.save {
				margin-right: 20px;
			}
			
			.bgWhite {
				background-color: white;
				height: 70px;
			}
			
			.checkJingjiaImg {
				box-sizing: border-box;
				border: 1px solid #25A9E1;
			}
			
			.layui-form-radio {
				font-size: 14px;
			}
			
			header {
				height: 40px;
				line-height: 40px;
				text-align: center;
				background-color: #25A9E1;
				color: white;
				font-size: 18px;
				position: relative;
			}
			
			.returnBtn {
				padding: 10px 20px;
				position: absolute;
				top: 0px;
				left: 0px;
				line-height: 20px;
			}
			
			.returnBtn img {
				width: 11.5px;
				height: 20px;
			}
			
			.rightChose {
				position: absolute;
				right: 0px;
				top: 0px;
				font-size: 14px;
			}
			
			.rightChose img {
				width: 18px;
				height: 18px;
				vertical-align: middle;
				padding: 10px;
				padding-top: 8px;
			}
			
			.rightChose:active {
				opacity: .2;
			}
			
			.choseGod {
				position: absolute;
				left: 0px;
				top: 40px;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, .2);
				overflow: hidden;
				z-index: 99;
				display: none;
			}
			
			.godMain {
				width: 230px;
				height: 100%;
				background-color: #fff;
				position: absolute;
				right: -230px;
				top: 0px;
				transition: right .3s;
			}
			
			.showChoesGod .choseGod {
				display: block;
			}
			
			.showChoesGod .toggle {
				right: 0px;
			}
			.w200{
				width: 200px;
			}
			.searchGod{
				text-align: center;
				padding: 10px 0px;
			}
			.searchInput{
				padding-left: 40px;
				position: relative;
			}
			.searchGod:after{
				content: '';
				display: block;
				position: absolute;
				left: 25px;
				top:20px;
				width: 20px;
				height: 20px;
				background: url(./imgs/searchIcon.png) no-repeat 0 0;
				background-size: 100% 100%;
			}
			.groupName{
				padding-left:20px;
				line-height: 40px;
				height: 40px;
				margin-left: 20px;
				position: relative;
				font-size: 16px;
				border-bottom: 1px solid #ccc;
				
			}
			.Grouping{
				height:calc(100% - 58px);
				overflow: auto;
			}
			.groupItem dl{
				display: block;
			}
			.groupItem dl dt{
				border-bottom: 1px solid #ccc;
				margin-left: 20px;
				height: 40px;
				line-height: 40px;
				padding-left: 40px;
				position: relative;
				color:#777;
			}
			.groupItem dl dt:active{
				background-color: #E5E5E5;
			}
			.groupItem{
				/*margin-top:10px ;*/
			}
			.groupItem dl dt:after{
				content: '';
				display: block;
				position: absolute;
				height: 20px;
				width: 20px;
				background: url(./imgs/storeIcon.png) no-repeat 0 0;
				background-size: 100% 100%;
				left: 10px;
				top:10px;
			}
			.selectIcon{
				display: inline-block;
				width: 7px;
				height: 14px;
				background: url(imgs/ic-shouqi.png) no-repeat 0 0;
				background-size: 100% 100%;
				position: absolute;
				top:12px;
				left:3.5px;
			}
			.hidelist .selectIcon{
				display: inline-block;
				width: 14px;
				height: 7px;
				background: url(imgs/i_xiala.png) no-repeat 0 0;
				background-size: 100% 100%;
				position: absolute;
				top:16px;
				left: 0px;
			}
			.hidelist dl{
				display: none;
			}
		</style>
	</head>

	<body>
		<header> <i class="returnBtn"><img src="imgs/return.png" alt="" /></i><span>新建加工单</span><span class="rightChose"><b>客户列表</b><img src="./imgs/listIcon.png" alt="" /></span></header>
		<div class="container">
			<form class="layui-form layui-clear">
				<div class="baseMsg">
					<div class="layui-form-item">
						<label class="layui-form-label">店铺名称：</label>
						<div class="layui-input-block w200">
							<select name="sid" id="sID" lay-verify="required">
								<option value=""></option>

							</select>
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">加工方：</label>
						<div class="layui-input-block w200">
							<select name="store" id="storeID" lay-verify="required">
								<option value=""></option>

							</select>
						</div>
					</div>

					<div class="layui-form-item">
						<label class="layui-form-label">店铺地址：</label>
						<div class="layui-input-block">
							<p class="p9 layui-elip" id="address"></p>
						</div>
					</div>
					<div class="layui-form-item">
						<label class="layui-form-label">联系方式：</label>
						<div class="layui-input-block">
							<p class="p9 layui-elip" id="tel"></p>
						</div>
					</div>

				</div>
				<div class="dingpeidan">
					<div class="title">订配信息填写</div>
					<div class="userType">
						<ul>
							<li class="userTypeCheck" name="0">近用</li>
							<li name="1">远用</li>
							<li name="2">多焦点</li>
						</ul>
					</div>
					<table class="layui-table">
						<thead>
							<tr>
								<th></th>
								<th>球镜</th>
								<th>柱镜</th>
								<th>轴位</th>
								<th>下加光</th>
								<th>瞳距</th>
								<th>近用瞳距</th>
								<th>瞳高</th>
							</tr>
						</thead>
						<tbody>
							<tr id="R_dp">
								<td>R</td>
								<td id="optometry_sph_right" name="SPH"></td>
								<td id="optometry_cyl_right" name="CYL"></td>
								<td id="optometry_OA_right" name="AX"></td>
								<td id="optometry_R" name="ADD"></td>
								<td id="optometry_PD_right" name="PD"></td>
								<td id="optometry_o1" name="jingyong"></td>
								<td id="optometry_PH_right" name="VD"></td>
							</tr>
							<tr id="L_dp">
								<td>L</td>
								<td id="optometry_sph_left" name="SPH"></td>
								<td id="optometry_cyl_left" name="CYL"></td>
								<td id="optometry_OA_left" name="AX"></td>
								<td id="optometry_ADD" name="ADD"></td>
								<td id="optometry_PD_left" name="PD"></td>
								<td id="optometry_PDjin" name="jingyong"></td>
								<td id="optometry_PH_left" name="VD"></td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="jingpianMsg">
					<div class="title">镜片信息</div>
					<div class="jingpianDetail layui-row">
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="sconedTitle">右（R）</div>
							<div class="jpDetails">
								<ul class="glassImgDetail layui-clear" id="R_xin">
									<li>
										<img src="./imgs/ic_zhanwuphoto.png" alt="" />

									</li>
									<li>
										<div class="jpArgs"><span>品牌</span>：<b name="lens_brand"></b></div>
										<div class="jpArgs"><span>品类</span>：<b name="lens_model"></b></div>
										<div class="jpArgs"><span>SPH</span>：<b name="sph"></b></div>
										<div class="jpArgs"><span>CYL</span>：<b name="cyl"></b></div>
										<div class="jpArgs"><span>ADD</span>：<b name="add"></b></div>
									</li>
								</ul>
								<div class="choseSrouce" id="R_supply">
									<div class="definBtn " name="Rjiagong" data-status="0">来片加工</div>
									<div class="definBtn " name="Rcenter" data-status="1">加工中心提供</div>

								</div>

							</div>
						</div>
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<div class="sconedTitle">左（L）</div>
							<div class="jpDetails">
								<ul class="glassImgDetail layui-clear" id="L_xin">
									<li>
										<img src="./imgs/ic_zhanwuphoto.png" alt="" />

									</li>
									<li>
										<div class="jpArgs"><span>品牌</span>：<b name="lens_brand"></b></div>
										<div class="jpArgs"><span>品类</span>：<b name="lens_model"></b></div>
										<div class="jpArgs"><span>SPH</span>：<b name="sph"></b></div>
										<div class="jpArgs"><span>CYL</span>：<b name="cyl"></b></div>
										<div class="jpArgs"><span>ADD</span>：<b name="add"></b></div>
									</li>
								</ul>
								<div class="choseSrouce" id="L_supply">
									<div class="definBtn" name="Ljiagong" data-status="0">来片加工</div>
									<div class="definBtn" name="Lcenter" data-status="1">加工中心提供</div>

								</div>

							</div>
						</div>

					</div>
				</div>
				<div class="jingjiaMsg">
					<div class="title">镜架信息</div>
					<div class="jjDetails layui-row">
						<ul class="glassImgDetail layui-clear layui-col-xs12 layui-col-sm6 layui-col-md6" id="F_xin">
							<li>
								<img src="./imgs/ic_zhanwuphoto.png" alt="" />

							</li>
							<li>
								<div class="jpArgs1"><span>品牌</span>：<b name="gframe_brand"></b></div>
								<div class="jpArgs1"><span>型号</span>：<b name="gframe_style"></b></div>
								<div class="jpArgs1"><span>系列号</span>：<b name="model_code"></b></div>
								<div class="jpArgs1"><span>类型</span>：<b name="gframe_frameType"></b></div>
							</li>
						</ul>
						<div class="layui-col-xs12 layui-col-sm6 layui-col-md6">
							<ul class="jingjiaChose layui-clear">
								<li name="ic_oblong.png"><img src="./imgs/ic_oblong.png" alt="" /></li>
								<li name="ic_oval.png"><img src="./imgs/ic_oval.png" alt="" /></li>
								<li name="ic_aviator.png"><img src="./imgs/ic_aviator.png" alt="" /></li>
								<li name="ic_catseyes.png"><img src="./imgs/ic_catseyes.png" alt="" /></li>
								<li name="ic_round.png"><img src="./imgs/ic_round.png" alt="" /></li>
								<li name="ic_cutawayretangle.png"><img src="./imgs/ic_cutawayretangle.png" alt="" /></li>
								<li name="ic_rectagle.png"><img src="./imgs/ic_rectagle.png" alt="" /></li>
								<li name="ic_cutawayoval.png"><img src="./imgs/ic_cutawayoval.png" /></li>
								<li name="ic_zhanwuphoto.png"><img src="./imgs/ic_zhanwuphoto.png" /></li>

							</ul>

							<div class="choseSrouce" id="F_supply">
								<div class="definBtn" name="jingjiajiagong" data-status="0">来架加工</div>
								<div class="definBtn" name="jingjiacenter" data-status="1">加工中心提供</div>

							</div>
						</div>

					</div>
				</div>
				<div class="gongyi layui-clear">
					<div class="title">加工工艺</div>
					<div class="layui-form-item">
						<label class="layui-form-label">镜片类型：</label>
						<div class="layui-input-block">
							<select name="lensType" id="lensType" lay-verify="required">
							</select>
						</div>
					</div>
					<ul class="gongyiList"></ul>
				</div>
				<div class="otherReq">
					<div class="title">其他要求</div>
					<div class="checkRL">
						<div class="jingjiaR check" name="0">右（R）</div>
						<div class="jingjiaL" name="1">左（L）</div>

					</div>
					<ul class="jingjiaArgs layui-clear">
						<li>
							<div class="layui-form-item">
								<label class="layui-form-label">边缘厚度</label>
								<div class="layui-input-block">
									<input type="text" name1="gframe_EdgeThickness_R" name2="gframe_EdgeThickness_L" required lay-verify="required" autocomplete="off" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">中心厚度</label>
								<div class="layui-input-block">
									<input type="text" name1="gframe_CenterThickness_R" name2="gframe_CenterThickness_L" required lay-verify="required" autocomplete="off" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">基弯要求</label>
								<div class="layui-input-block">
									<input type="text" name1="gframe_jiwan_R" name2="gframe_jiwan_L" required lay-verify="required" autocomplete="off" class="layui-input">
								</div>
							</div>
						</li>
						<li>
							<div class="layui-form-item">
								<label class="layui-form-label">基弯相配</label>
								<div class="layui-input-block">
									<input type="text" name1="gframe_jiwanMatch_R" name2="gframe_jiwanMatch_L" required lay-verify="required" autocomplete="off" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">厚薄相配</label>
								<div class="layui-input-block">
									<input type="text" name1="gframe_thicknessMatch_R" name2="gframe_thicknessMatch_L" required lay-verify="required" autocomplete="off" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">方向</label>
								<div class="layui-input-block">
									<input type="text" name1="gframe_aspect_R" name2="gframe_aspect_L" required lay-verify="required" autocomplete="off" class="layui-input">
								</div>
							</div>
						</li>
					</ul>
					<div class="beizhu">
						<span class="beizhuMark">备注：</span>
						<textarea class="layui-textarea" id="ity_remark"></textarea>
					</div>
				</div>
				<p class=" allPrice"><span>总价</span>：<b id="price"></b></p>
				<div class="bgWhite"><button class="layui-btn save fr layui-bg-orange" type="button" id="save">保 存</button></div>
				<div class="choseGod">
					<div class="godMain">
						<div class="searchGod">
							<input type="text" class="layui-input layui-input-inline  w200 searchInput"/>
						</div>
						<ul class="Grouping">
							<li class="groupItem hidelist">
								<p class="groupName"><i class="selectIcon"></i><span>默认分组</span></p>
								<dl>
									<dt>九月六号点</dt>
									<dt>上海总店</dt>
									<dt>中南海专供店</dt>
									<dt>御用眼镜店</dt>
									
								</dl>
							</li>
							<li class="groupItem hidelist">
								<p class="groupName"><i class="selectIcon"></i><span>直营店</span></p>
								<dl>
									<dt>文导精品眼镜店</dt>
									<dt>文导专供眼镜店</dt>
									<dt>文导老花眼镜店</dt>
									<dt>文导透视眼镜店</dt>
									
								</dl>
							</li>
							<li class="groupItem hidelist">
								<p class="groupName"><i class="selectIcon"></i><span>总店</span></p>
								<dl>
									<dt>文导伊朗专卖店</dt>
									<dt>文导印尼专卖店</dt>
									<dt>文导孟买专卖店</dt>
									<dt>文导曼谷专卖店</dt>
									
								</dl>
							</li>
							<li class="groupItem hidelist">
								<p class="groupName"><i class="selectIcon"></i><span>零售店</span></p>
								<dl>
									<dt>文导橘色零售店</dt>
									<dt>文导东京零售店</dt>
									<dt>文导hot零售店</dt>
									<dt>文导什么都卖零售店</dt>
									
								</dl>
							</li>
						</ul>
					</div>

				</div>
			</form>

		</div>

		<script src="layui.all.js"></script>
		<script src="zepto.js"></script>
		<script src="./js/publicNum.js"></script>
		<script>
			//全局变量保存

			var height_total = document.documentElement.clientHeight;
			console.log(height_total)

			$('.choseGod').css('height', height_total - 40 + 'px');
		

			$('.rightChose').tap(function() {
				$('.container').toggleClass('showChoesGod');
				setTimeout(function() {
					$('.godMain').toggleClass('toggle');
				}, 10)
			})
			
			$('.groupName').tap(function(){
				$(this).parent().toggleClass('hidelist');
			})
			
			var store_id = 0; //页面传过来的店铺ID
			var storeId_x = {}; //查出加工店铺的信息如电话地址等
			var url = 'http://jingliyun.cn/jlyyj/index.php/Home/JavaInterface/'; //全局url路径定义
			var can_num = {
				"1": "1",
				"5": "1",
				"6": "1",
				"7": "1",
				"10": "1",
				"13": "1",
				"17": "1",
				"18": "1"
			} //判断工艺是否需要填值
			var price = {}; //保存加工价、总价、商品、镜架、镜片价格
			var goodsAll = {
				"L": {},
				"R": {},
				"F": {}
			}; //保存商品信息
			var goods_xin = [];
			var layer = layui.layer,
				form = layui.form;
			var user_id = 2;
			var store_id = 54;
			var stores = {};

			var arr = [{
					'name': '模型加工',
					'id': 'moxing',
					'gongyi': [{
							'type': '无框标准加工',
							'price': '-1',
							'check': false,
							'id': '20'
						},
						{
							'type': '半框标准加工',
							'price': '-1',
							'check': false,
							'id': '21'
						},
						{
							'type': '全框标准加工',
							'price': '-1',
							'check': false,
							'id': '22'
						}
					],
					'check': false
				},
				{
					'name': '钻孔',
					'price': '-1',
					'num': '',
					'check': false,
					'id': '1'
				},
				{
					'name': '倒边',
					'id': 'daobian',
					'gongyi': [{
							'type': '倒边A',
							'price': '-1',
							'check': false,
							'id': '2'
						},
						{
							'type': '倒边B',
							'price': '-1',
							'check': false,
							'id': '3'
						},
						{
							'type': '倒边C',
							'price': '-1',
							'check': false,
							'id': '4'
						}
					],
					'num': '',
					'check': false
				},
				{
					'name': '割边',
					'num': '',
					'price': '-1',
					'check': false,
					'id': '5'
				},
				{
					'name': '改型',
					'id': 'gaixing',
					'gongyi': [{
							'type': '左右改型',
							'num': '',
							'price': '-1',
							'check': false,
							'id': '6'
						},
						{
							'type': '上下改型',
							'num': '',
							'price': '-1',
							'check': false,
							'id': '7'
						}
					],
					'check': false
				},
				{
					'name': '染色单色',
					'id': 'randanse',
					'gongyi': [{
							'details': [

								{
									'type': '来色板',
									'price': '-1',
									'check': false,
									'id': '8'
								},
								{
									'type': '来色架',
									'price': '-1',
									'check': false,
									'id': '9'
								}
							]

						},
						{
							'type': '色度',
							'price': '-1',
							'check': false,
							'id': '10',
							'num': ''
						}
					],
					'check': false
				},
				{
					'name': '染色双色',
					'id': 'ranshuangse',
					'gongyi': [{
							'details': [

								{
									'type': '来色板',
									'price': '-1',
									'check': false,
									'id': '11'
								},
								{
									'type': '来色架',
									'price': '-1',
									'check': false,
									'id': '12'
								}
							]

						},
						{
							'type': '色度',
							'price': '-1',
							'num': '',
							'check': false,
							'id': '13'
						}
					],
					'check': false
				},
				{
					'name': '抛边',
					'price': '-1',
					'check': false,
					'id': '14'
				},
				{
					'name': '潜水镜',
					'price': '-1',
					'check': false,
					'id': '15'
				},
				{
					'name': '批花',
					'price': '-1',
					'check': false,
					'id': '16'
				},
				{
					'name': '倒角',
					'num': '',
					'price': '-1',
					'check': false,
					'id': '17'
				}, {
					'name': '特殊基弯',
					'num': '',
					'price': '-1',
					'check': false,
					'id': '18'
				},
				{
					'name': '投保费',
					'price': '-1',
					'check': false,
					'id': '19'
				}
			]
			//由于模块都一次性加载，因此不用执行 layui.use() 来加载对应模块，直接使用即可：
			var jly_publicNum = new jly_publicNum();;
			//			console.log(jly_publicNum.yanguang);
			(function() {

				load_store()

				function load_store() {
					var sql = 'SELECT u.level AS user_level, u.store_id AS store_id, u.store_name AS store_name, u.boss_id AS boss_id, u.bossname AS boss_name ,u.zd_id AS zd_id,u.store_Type AS storetype FROM view_login2 u WHERE u.user_id = ' + user_id + ' AND IFNULL(u.store_status = 0, 1 = 1) ORDER BY store_id DESC';
					var id = '{"code":"A11","accesstoken":"' + sql + '"}';
					$.ajax({
						url: url + 'findgoods1',
						type: 'get',
						dataType: 'jsonp',
						jsonpCallback: 'successCallback',
						data: {
							"id": id
						},
						success: function(data) {
							if(data.code == 200) {
								var list = data.data;

								var str = "";
								for(var i = 0; i < list.length; i++) {
									str += "<option value=" + list[i].store_id + ">" + list[i].store_name + "</option>";
									if(list[i].zd_id) {
										stores[list[i].store_id + ""] = list[i].zd_id;
									} else {
										stores[list[i].store_id + ""] = list[i].store_id;
									}
								}
								$("#sID").html(str);
								form.render();
								store_id = list[0].store_id;
								if(store_id) {
									var ids_1 = '{"code":"A11","accesstoken":"SELECT a.*,b.store_name as s_name1,c.store_name as s_name2,b.store_address,b.store_phone,b.zd_id FROM tb_storemachining a left join tb_store b on a.sm_multid=b.store_id  left join tb_store c on a.sm_storeid=c.store_id where sm_status=0 and sm_storeid=' + store_id + '"}';
									load_dian(ids_1);
								}
							} else if(data.code == 201) {
								layer.msg("未查到店铺");
							}
						}
					})
				}
				//jly_publicNum.yanguang(function(obj){
				//	console.log(obj);
				//})
				var initObj = {
					'R': {
						'CYL': '+0.00',
						'PD': '36',
						'SPH': '+0.00',
						'AX': '0',
						'ADD': '0.75',
						'jingyong': '15',
						'VD': '32',
					},
					'L': {
						'CYL': '+0.00',
						'PD': '36',
						'SPH': '+0.00',
						'AX': '0',
						'ADD': '0.75',
						'jingyong': '15',
						'VD': '34',
					},
					'hebing': true
				}
				$('.dingpeidan .layui-table').tap(function() {
					var that = this;
					jly_publicNum.yanguang(function(obj) {
						initObj = obj;
						$(that).find('tbody tr').each(function(index, item) {
							$(item).find('td').each(function(index1, item1) {
								if($(item1).attr('name')) {
									if(index == 0) {
										$(item1).text(initObj.R[$(item1).attr('name')]);
										console.log(item1)
									} else if(index == 1) {
										$(item1).text(initObj.L[$(item1).attr('name')]);
									}
								}
							})

						})
						if(initObj.hebing) {
							$($(that).find('tbody tr')[0]).find('td[name=PD]').attr('rowspan', '2');
							$($(that).find('tbody tr')[1]).find('td[name=PD]').hide();
						} else {
							$($(that).find('tbody tr')[0]).find('td[name=PD]').attr('rowspan', '1');
							$($(that).find('tbody tr')[1]).find('td[name=PD]').show();
						}
					}, initObj)
				})

				//镜架图片选择事件注册

				$('.jingjiaChose li').tap(function() {
					var that = this;
					$('.jingjiaChose li').each(function(index, item) {
						if($(that).attr('name') != $(item).attr('name')) {
							$(item).removeClass('checkJingjiaImg');
						}
					})
					if($(this).attr('name') != 'ic_zhanwuphoto') {
						$(this).toggleClass('checkJingjiaImg');
					}

				})

				// 来架 来片 加工中心
				$('.definBtn').tap(function() {
					var that = this;
					if(!$("#sID").val() || !$("#storeID").val()) {
						layer.msg("请确认加工方店铺或发起方店铺");
						return;
					}
					/* $(this).parent().find('.definBtn').each(function(index,item){
					 if($(that).attr('name')!=$(item).attr('name')){
					 $(item).removeClass('check');
					 }
					 }) */

					var type = 1; //传递类型
					var divId = $(this).parent().attr("id");
					if($(this).hasClass('check')) {
						$(this).toggleClass('check')
						//清空操作
						qing_div(divId.substring(0, 1) + "_xin")
						goodsAll[divId.substring(0, 1) + ""] = {};
						//重新计算金额
						getArrDate();
						return;
					}
					var st = 1;
					var sph = "";
					var cyl = "";
					var name = $(this).attr('name');
					if(name == 'Rjiagong') {
						//右眼来片加工
						st = 1;
						type = 1;
						sph = $("#optometry_sph_right").html();
						cyl = $("#optometry_cyl_right").html();

					} else if(name == 'Rcenter') {
						//右眼加工中心提供
						st = 2;
						type = 2;
						sph = $("#optometry_sph_right").html();
						cyl = $("#optometry_cyl_right").html();
					} else if(name == 'Ljiagong') {
						//左眼来片加工
						st = 1;
						type = 3;
						sph = $("#optometry_sph_left").html();
						cyl = $("#optometry_cyl_left").html();
					} else if(name == 'Lcenter') {
						//左眼加工中心提供
						st = 2;
						type = 4;
						sph = $("#optometry_sph_left").html();
						cyl = $("#optometry_cyl_left").html();
					} else if(name == 'jingjiajiagong') {
						//来架加工
						st = 1;
						type = 5;
					} else if(name == 'jingjiacenter') {
						//镜架加工中心提供
						st = 2;
						type = 6;
					}
					if(st == 1) {
						var s_id = store_id;
						var z_id = stores[store_id + ""];

					} else if(st == 2) {
						var s_id = $("#storeID").val();
						if(!s_id) {
							layer.msg("请选择加工方店铺")
							return;
						}
						var z_id = storeId_x[s_id + ""]["zd_id"];
						if(!z_id) {
							z_id = s_id;
						}
					}

					if(st == 1) {
						if(type != 5 && type != 6) {
							if(cyl == "" || sph == "") {
								layer.msg("请填写定配单信息")
								return;
							}
						}

						layer.confirm('请选择商品提供方', {
							btn: ['顾客自带', '门店提供'] //可以无限个按钮
						}, function(index) {
							layer.close(index);
							$(that).parent().find('.definBtn').each(function(index, item) {
								$(item).removeClass('check');
							})
							$("#" + divId.substring(0, 1) + "_xin").find("img").attr("src", "http://jingliyun.cn/jlyyj/Public/img/ic_zhanwuphoto.png");
							if(type == 1 || type == 3) {
								goodsAll[divId.substring(0, 1) + ""] = {
									"goods_id": "0",
									"goodsType": "1",
									"goods_storeid": store_id,
									"price": 0
								};
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=lens_brand]").html("");
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=lens_model]").html("");
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=sph]").html($("#" + divId.substring(0, 1) + "_dp").find("td[name=SPH]").html());
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=cyl]").html($("#" + divId.substring(0, 1) + "_dp").find("td[name=SPH]").html());
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=add]").html($("#" + divId.substring(0, 1) + "_dp").find("td[name=ADD]").html());
								$(that).addClass("check");
							} else {
								goodsAll[divId.substring(0, 1) + ""] = {
									"goods_id": "0",
									"goodsType": "2",
									"goods_storeid": store_id,
									"price": 0
								};
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=gframe_brand]").html("顾客自带商品");
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=gframe_style]").html("");
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=model_code]").html("");
								$("#" + divId.substring(0, 1) + "_xin").find("b[name=gframe_frameType]").html("");
								$(that).addClass("check");
							}
							getArrDate();
						}, function(index) {
							layer.open({
								title: false,
								type: 2,
								closeBtn: 0,
								anim: 1,
								area: ['100%', '100%'],
								content: ['goodsChoose.html?store_id=' + s_id + '&zd_id=' + z_id + '&status=' + type + '&sph=' + sph + '&cyl=' + cyl, 'no']
							})
						});
					} else {
						layer.open({
							title: false,
							type: 2,
							closeBtn: 0,
							anim: 1,
							area: ['100%', '100%'],
							content: ['goodsChoose.html?store_id=' + s_id + '&zd_id=' + z_id + '&status=' + type + '&sph=' + sph + '&cyl=' + cyl, 'no']
						})
					}

				})

				//近用远用多焦点事件
				$('.userType ul li').tap(function() {
					$('.userType ul li').removeClass('userTypeCheck');
					$(this).addClass('userTypeCheck');

				})
				var jingjiaArgs = {
					eyes: '0',
					gframe_EdgeThickness_R: '',
					gframe_CenterThickness_R: '',
					gframe_jiwan_R: '',
					gframe_jiwanMatch_R: '',
					gframe_thicknessMatch_R: '',
					gframe_aspect_R: '',
					gframe_EdgeThickness_L: '',
					gframe_CenterThickness_L: '',
					gframe_jiwan_R: '',
					gframe_jiwanMatch_L: '',
					gframe_thicknessMatch_L: '',
					gframe_aspect_L: ''
				}
				//镜架参数获取
				$('.checkRL div').tap(function() {
					var that = this;
					$(this).parent().find('div').each(function(index, item) {
						if($(that).attr('name') != $(item).attr('name')) {
							$(item).removeClass('check');
						}
					})
					$(this).addClass('check');
					jingjiaArgs.eyes = $(this).attr('name');

					$('.jingjiaArgs input').each(function(index, item) {
						$(item).val(jingjiaArgs[$(item).attr('name' + (jingjiaArgs.eyes / 1 + 1))]);
					})

				})

				$('.jingjiaArgs input').keyup(function() {
					jingjiaArgs[$(this).attr('name' + (jingjiaArgs.eyes / 1 + 1))] = $(this).val();
				})

				gongyi(arr, true)

				function gongyi(arr, boolean) {
					var gongyiStr = '';
					console.log(123);
					arr.forEach(function(item, index) {
						var id = item.id;

						if((id == '15' || id == '16' || id == '19' || id == '14') && item.price != -1) { //抛边，潜水镜，批花，投保费
							gongyiStr += '<li  class="clearfix" data-num="' + index + '">' +
								'<div class="checkMain fl" name="' + item.id + '">' +
								'<span>' + item.name + '</span>' +
								'<div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div>' +
								'</div>' +
								'<div class="details fl">' +
								'<div class="showPrice"><span>价格</span>：<span class="priceText">' + item.price + '</span><span>元</span></div>' +
								'</div>' +
								'</li>';

						} else if((id == "1" || id == "5" || id == "17" || id == "18") && item.price != -1) { //钻孔，割边，倒角，特殊基弯
							gongyiStr += '<li  class="clearfix" data-num="' + index + '">' +
								'<div class="checkMain fl" name="' + item.id + '">' +
								'<span>' + item.name + '</span>' +
								'<div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div>' +
								'</div>' +
								'<div class="details fl">' +
								'<input type="text" class="gongyiInput layui-input" value="' + item.num + '" ' + (item.check ? '' : 'readonly') + '>' +
								'<div class="showPrice"><span>价格</span>：<span class="priceText">' + item.price + '</span><span>元</span></div>' +
								'</div>' +
								'</li>';
						} else if(id == 'moxing') { //模型加工
							if(item.gongyi.some(function(x) {
									return x.price != -1
								})) {
								gongyiStr += '<li  class="clearfix" data-num="' + index + '"><div class="checkMain fl" name="' + item.id + '"><span >' + item.name + '</span><div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div></div>';

								item.gongyi.forEach(function(item1, index1) {
									if(item1.price != -1) {
										gongyiStr += '<div class="details fl">' +
											'<div class="moxing" num="' + index1 + '"><span class="smallIconUncheck ' + (item1.check ? 'smallIconCheck' : '') + '"></span><span class="moxingText">' + item1.type + '</span></div>' +
											'<div class="showPrice"><span class="priceText">' + item1.price + '</span><span>元</span></div>' +
											'</div>'
									}
								})
								gongyiStr += '</li>';
							}

						} else if(id == 'daobian') { //倒边渲染
							if(item.gongyi.some(function(x) {
									return x.price != -1
								})) {
								gongyiStr += '<li  class="clearfix" data-num="' + index + '"><div class="checkMain fl" name="' + item.id + '"><span >' + item.name + '</span><div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div></div>';

								item.gongyi.forEach(function(item1, index1) {
									if(item1.price != -1) {
										gongyiStr += '<div class="details fl">' +
											'<div class="moxing" num="' + index1 + '"><span class="smallIconUncheck ' + (item1.check ? 'smallIconCheck' : '') + '"></span><span class="moxingText">' + item1.type + '</span></div>' +
											'<div class="showPrice"><span class="priceText">' + item1.price + '</span><span>元</span></div>' +
											'</div>'
									}
								})
								gongyiStr += '<div class="details fl"><input type="text" class="gongyiInput layui-input" value="' + item.num + '" ' + (item.check ? '' : 'readonly') + '></div></li>';
							}
						} else if(id == 'gaixing') { //改型

							if(item.gongyi.some(function(x) {
									return x.price != -1
								})) {
								gongyiStr += '<li  class="clearfix" data-num="' + index + '"><div class="checkMain fl" name="' + item.id + '"><span >' + item.name + '</span><div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div></div>';
								item.gongyi.forEach(function(item1, index1) {
									if(item1.price != -1) {
										gongyiStr += '<div class="details fl">' +
											'<div class="moxing" num="' + index1 + '"><span class="smallIconUncheck ' + (item1.check ? 'smallIconCheck' : '') + '"></span><span class="moxingText">' + item1.type + '</span></div>' +
											'<div class="showPrice"><span class="priceText">' + item1.price + '</span><span>元</span></div>' +
											'</div>' +
											'<div class="details fl"> <input type="text" class="gongyiInput layui-input" value="' + item1.num + '" ' + (item1.check ? '' : 'readonly') + ' num="' + index1 + '"></div>'
									}
								})
								gongyiStr += '</li>'
							}
						} else if(id == 'ranshuangse' || id == 'randanse') { //染单色 染双色
							if(item.gongyi[0].details.some(function(x) {
									return x.price != -1
								}) || item.gongyi[1].price != -1) {
								console.log(item.gongyi[1].price);
								gongyiStr += '<li  class="clearfix" data-num="' + index + '"><div class="checkMain fl" name="' + item.id + '"><span >' + item.name + '</span><div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div></div>';
								item.gongyi[0].details.forEach(function(item1, index1) {
									if(item1.price != -1) {

										gongyiStr += '<div class="details fl">' +
											'<div class="moxing" num="' + index1 + '" type="1"><span class="smallIconUncheck ' + (item1.check ? 'smallIconCheck' : '') + '"></span><span class="moxingText">' + item1.type + '</span></div>' +
											'<div class="showPrice"><span class="priceText">' + item1.price + '</span><span>元</span></div>' +
											'</div>'
									}
								})
								if(item.gongyi[1].price != -1) {
									gongyiStr += '<div class="details fl">' +
										'<div class="moxing ranse" type="2"><span class="moxingText">' + item.gongyi[1].type + '</span> <div class="icon iconNoCheck ' + (item.gongyi[1].check ? 'iconCheck' : '') + '" ></div></div>' +
										'<input type="text" class="gongyiInput layui-input" value="' + item.gongyi[1].num + '" placeholder="%" ' + (item.gongyi[1].check ? '' : 'readonly') + '>' +
										'<div class="showPrice"><span class="priceText">' + item.gongyi[1].price + '</span><span>元</span></div>' +
										'</div>'
								}
								gongyiStr += '</li>'
							}
						}
					});

					$('.gongyiList').html(gongyiStr);

					if(boolean) {
						$('.checkMain').tap(function() {
							var that = this;

							var index = $(this).parent()[0].dataset.num;
							arr[index].check = !arr[index].check;
							if(!arr[index].check) {
								switchFale(index / 1)
							} else {
								if(index == 0 || index == 2 || index == 4) { //默认选中的项

									for(var i = 0; i < arr[index].gongyi.length; i++) {
										if(arr[index].gongyi[i].price != -1) {
											arr[index].gongyi[i].check = true;
											break;
										}
									}
								}
							}
							goodsGongyiRender(arr)
							getArrDate()
						});
						$('.moxing').tap(function() { //二级按钮点击事件监听
							var that = this;
							switch($(that).parents('li')[0].dataset.num / 1) {
								case 0: //模型加工
									if(arr[0].check) {
										arr[0].gongyi.forEach(function(item, index) {
											item.check = false;
										})
										arr[0].gongyi[$(that).attr('num')].check = true;
									}
									break;
								case 2: //倒边
									if(arr[2].check) {
										arr[2].gongyi.forEach(function(item, index) {
											item.check = false;
										})
										arr[2].gongyi[$(that).attr('num')].check = true;
									}
									break;
								case 4: //改型
									if(arr[4].check) {
										var mark = arr[4].gongyi[$(that).attr('num')].num;
										arr[4].gongyi.forEach(function(item, index) {
											item.num = '';
											item.check = false;
										})
										arr[4].gongyi[$(that).attr('num')].check = true;
										arr[4].gongyi[$(that).attr('num')].num = mark;
									}
									break;
								case 5: //染色单色
									if(arr[5].check) {
										var type = $(that).attr('type');
										if(type == 1) {
											var i = $(that).attr('num');
											arr[5].gongyi[0].details.forEach(function(item2, index2) {
												item2.check = false;
											})
											arr[5].gongyi[0].details[i].check = true;
										} else if(type == 2) {
											arr[5].gongyi[1].check = !arr[5].gongyi[1].check;
											arr[5].gongyi[1].num = '';
										}
									}
									break;
								case 6: //染色双色
									if(arr[6].check) {
										var type = $(that).attr('type');
										if(type == 1) {
											var i = $(that).attr('num');
											arr[6].gongyi[0].details.forEach(function(item2, index2) {
												item2.check = false;
											})
											arr[6].gongyi[0].details[i].check = true;
										} else if(type == 2) {
											arr[6].gongyi[1].check = !arr[6].gongyi[1].check;
											arr[6].gongyi[1].num = '';
										}
									}
									break;

							}
							goodsGongyiRender(arr);
							getArrDate()
						})

						$('.gongyiInput').keyup(function() {
							var reg = $(this).val().match(/\d+\.?\d{0,2}/);
							var txt = '';
							if(reg != null) {
								txt = reg[0];
							}
							$(this).val(txt);
							var that = this;
							var index = $(that).parents('li')[0].dataset.num / 1;
							if(arr[index].check) {
								if(index == 1 || index == 2 || index == 3 || index == 10 || index == 11) {
									arr[index].num = $(that).val();
									console.log(arr[index]);
								}
								if(index == 4) {
									arr[4].gongyi[$(that).attr("num")].num = $(that).val();
								}
								if(index == 5 || index == 6) {
									arr[index].gongyi[1].num = $(that).val();
								}
							}

						}).change(function() {
							$(this).keypress();
							var v = $(this).val();
							if(/\.$/.test(v)) {
								$(this).val(v.substr(0, v.length - 1));
							}
							var that = this;
							var index = $(that).parents('li')[0].dataset.num / 1;
							if(arr[index].check) {
								if(index == 1 || index == 2 || index == 3 || index == 10 || index == 11) {
									arr[index].num = $(that).val();
									console.log(arr[index]);
								}
								if(index == 4) {
									arr[4].gongyi[$(that).attr("num")].num = $(that).val();
								}
								if(index == 5 || index == 6) {
									arr[index].gongyi[1].num = $(that).val();
								}
							}

						});
					}

				}

				function goodsGongyiRender(arr) {
					var gongyiStr = '';
					arr.forEach(function(item, index) {
						var id = item.id;

						if((id == '15' || id == '16' || id == '19' || id == '14') && item.price != -1) { //抛边，潜水镜，批花，投保费
							gongyiStr += '<li  class="clearfix" data-num="' + index + '">' +
								'<div class="checkMain fl" name="' + item.id + '">' +
								'<span>' + item.name + '</span>' +
								'<div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div>' +
								'</div>' +
								'<div class="details fl">' +
								'<div class="showPrice"><span>价格</span>：<span class="priceText">' + item.price + '</span><span>元</span></div>' +
								'</div>' +
								'</li>';

						} else if((id == "1" || id == "5" || id == "17" || id == "18") && item.price != -1) { //钻孔，割边，倒角，特殊基弯
							gongyiStr += '<li  class="clearfix" data-num="' + index + '">' +
								'<div class="checkMain fl" name="' + item.id + '">' +
								'<span>' + item.name + '</span>' +
								'<div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div>' +
								'</div>' +
								'<div class="details fl">' +
								'<input type="text" class="gongyiInput layui-input" value="' + item.num + '" ' + (item.check ? '' : 'readonly') + '>' +
								'<div class="showPrice"><span>价格</span>：<span class="priceText">' + item.price + '</span><span>元</span></div>' +
								'</div>' +
								'</li>';
						} else if(id == 'moxing') { //模型加工
							if(item.gongyi.some(function(x) {
									return x.price != -1
								})) {
								gongyiStr += '<li  class="clearfix" data-num="' + index + '"><div class="checkMain fl" name="' + item.id + '"><span >' + item.name + '</span><div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div></div>';

								item.gongyi.forEach(function(item1, index1) {
									if(item1.price != -1) {
										gongyiStr += '<div class="details fl">' +
											'<div class="moxing" num="' + index1 + '"><span class="smallIconUncheck ' + (item1.check ? 'smallIconCheck' : '') + '"></span><span class="moxingText">' + item1.type + '</span></div>' +
											'<div class="showPrice"><span class="priceText">' + item1.price + '</span><span>元</span></div>' +
											'</div>'
									}
								})
								gongyiStr += '</li>';
							}

						} else if(id == 'daobian') { //倒边渲染
							if(item.gongyi.some(function(x) {
									return x.price != -1
								})) {
								gongyiStr += '<li  class="clearfix" data-num="' + index + '"><div class="checkMain fl" name="' + item.id + '"><span >' + item.name + '</span><div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div></div>';

								item.gongyi.forEach(function(item1, index1) {
									if(item1.price != -1) {
										gongyiStr += '<div class="details fl">' +
											'<div class="moxing" num="' + index1 + '"><span class="smallIconUncheck ' + (item1.check ? 'smallIconCheck' : '') + '"></span><span class="moxingText">' + item1.type + '</span></div>' +
											'<div class="showPrice"><span class="priceText">' + item1.price + '</span><span>元</span></div>' +
											'</div>'
									}
								})
								gongyiStr += '<div class="details fl"><input type="text" class="gongyiInput layui-input" value="' + item.num + '" ' + (item.check ? '' : 'readonly') + '></div></li>';
							}
						} else if(id == 'gaixing') { //改型

							if(item.gongyi.some(function(x) {
									return x.price != -1
								})) {
								gongyiStr += '<li  class="clearfix" data-num="' + index + '"><div class="checkMain fl" name="' + item.id + '"><span >' + item.name + '</span><div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div></div>';
								item.gongyi.forEach(function(item1, index1) {
									if(item1.price != -1) {
										gongyiStr += '<div class="details fl">' +
											'<div class="moxing" num="' + index1 + '"><span class="smallIconUncheck ' + (item1.check ? 'smallIconCheck' : '') + '"></span><span class="moxingText">' + item1.type + '</span></div>' +
											'<div class="showPrice"><span class="priceText">' + item1.price + '</span><span>元</span></div>' +
											'</div>' +
											'<div class="details fl"> <input type="text" class="gongyiInput layui-input" value="' + item1.num + '" ' + (item1.check ? '' : 'readonly') + ' num="' + index1 + '"></div>'
									}
								})
								gongyiStr += '</li>'
							}
						} else if(id == 'ranshuangse' || id == 'randanse') { //染单色 染双色
							if(item.gongyi[0].details.some(function(x) {
									return x.price != -1
								}) || item.gongyi[1].price != -1) {
								console.log(item.gongyi[1].price);
								gongyiStr += '<li  class="clearfix" data-num="' + index + '"><div class="checkMain fl" name="' + item.id + '"><span >' + item.name + '</span><div class="icon iconNoCheck ' + (item.check ? 'iconCheck' : '') + '" ></div></div>';
								item.gongyi[0].details.forEach(function(item1, index1) {
									if(item1.price != -1) {

										gongyiStr += '<div class="details fl">' +
											'<div class="moxing" num="' + index1 + '" type="1"><span class="smallIconUncheck ' + (item1.check ? 'smallIconCheck' : '') + '"></span><span class="moxingText">' + item1.type + '</span></div>' +
											'<div class="showPrice"><span class="priceText">' + item1.price + '</span><span>元</span></div>' +
											'</div>'
									}
								})
								if(item.gongyi[1].price != -1) {
									gongyiStr += '<div class="details fl">' +
										'<div class="moxing ranse" type="2"><span class="moxingText">' + item.gongyi[1].type + '</span> <div class="icon iconNoCheck ' + (item.gongyi[1].check ? 'iconCheck' : '') + '" ></div></div>' +
										'<input type="text" class="gongyiInput layui-input" value="' + item.gongyi[1].num + '" placeholder="%" ' + (item.gongyi[1].check ? '' : 'readonly') + '>' +
										'<div class="showPrice"><span class="priceText">' + item.gongyi[1].price + '</span><span>元</span></div>' +
										'</div>'
								}
								gongyiStr += '</li>'
							}
						}
					});

					$('.gongyiList').html(gongyiStr);

					$('.checkMain').tap(function() {
						var that = this;

						var index = $(this).parent()[0].dataset.num;
						arr[index].check = !arr[index].check;
						if(!arr[index].check) {
							switchFale(index / 1)
						} else {
							if(index == 0 || index == 2 || index == 4) { //默认选中的项

								for(var i = 0; i < arr[index].gongyi.length; i++) {
									if(arr[index].gongyi[i].price != -1) {
										arr[index].gongyi[i].check = true;
										break;
									}
								}
							}
						}
						goodsGongyiRender(arr)
						getArrDate()
					});
					$('.moxing').tap(function() { //二级按钮点击事件监听
						var that = this;
						switch($(that).parents('li')[0].dataset.num / 1) {
							case 0: //模型加工
								if(arr[0].check) {
									arr[0].gongyi.forEach(function(item, index) {
										item.check = false;
									})
									arr[0].gongyi[$(that).attr('num')].check = true;
								}
								break;
							case 2: //倒边
								if(arr[2].check) {
									arr[2].gongyi.forEach(function(item, index) {
										item.check = false;
									})
									arr[2].gongyi[$(that).attr('num')].check = true;
								}
								break;
							case 4: //改型
								if(arr[4].check) {
									var mark = arr[4].gongyi[$(that).attr('num')].num;
									arr[4].gongyi.forEach(function(item, index) {
										item.num = '';
										item.check = false;
									})
									arr[4].gongyi[$(that).attr('num')].check = true;
									arr[4].gongyi[$(that).attr('num')].num = mark;
								}
								break;
							case 5: //染色单色
								if(arr[5].check) {
									var type = $(that).attr('type');
									if(type == 1) {
										var i = $(that).attr('num');
										arr[5].gongyi[0].details.forEach(function(item2, index2) {
											item2.check = false;
										})
										arr[5].gongyi[0].details[i].check = true;
									} else if(type == 2) {
										arr[5].gongyi[1].check = !arr[5].gongyi[1].check;
										arr[5].gongyi[1].num = '';
									}
								}
								break;
							case 6: //染色双色
								if(arr[6].check) {
									var type = $(that).attr('type');
									if(type == 1) {
										var i = $(that).attr('num');
										arr[6].gongyi[0].details.forEach(function(item2, index2) {
											item2.check = false;
										})
										arr[6].gongyi[0].details[i].check = true;
									} else if(type == 2) {
										arr[6].gongyi[1].check = !arr[6].gongyi[1].check;
										arr[6].gongyi[1].num = '';
									}
								}
								break;

						}
						goodsGongyiRender(arr);
						getArrDate();
					})

					$('.gongyiInput').keyup(function() {
						var reg = $(this).val().match(/\d+\.?\d{0,2}/);
						var txt = '';
						if(reg != null) {
							txt = reg[0];
						}
						$(this).val(txt);
						var that = this;
						var index = $(that).parents('li')[0].dataset.num / 1;
						if(arr[index].check) {
							if(index == 1 || index == 2 || index == 3 || index == 10 || index == 11) {
								arr[index].num = $(that).val();
								console.log(arr[index]);
							}
							if(index == 4) {
								arr[4].gongyi[$(that).attr("num")].num = $(that).val();
							}
							if(index == 5 || index == 6) {
								arr[index].gongyi[1].num = $(that).val();
							}
						}

					}).change(function() {
						$(this).keypress();
						var v = $(this).val();
						if(/\.$/.test(v)) {
							$(this).val(v.substr(0, v.length - 1));
						}
						var that = this;
						var index = $(that).parents('li')[0].dataset.num / 1;
						if(arr[index].check) {
							if(index == 1 || index == 2 || index == 3 || index == 10 || index == 11) {
								arr[index].num = $(that).val();
								console.log(arr[index]);
							}
							if(index == 4) {
								arr[4].gongyi[$(that).attr("num")].num = $(that).val();
							}
							if(index == 5 || index == 6) {
								arr[index].gongyi[1].num = $(that).val();
							}
						}

					});

				}

				function switchFale(index) {
					switch(index / 1) {
						case 0:
							arr[index].gongyi.forEach(function(item1, index1) {
								item1.check = false;
							})
							break;
						case 1:
							arr[index].num = '';
							break;
						case 2:
							arr[index].gongyi.forEach(function(item1, index1) {
								item1.check = false;
							})
							arr[index].num = '';
							break;
						case 3:
							arr[index].num = '';
							break;
						case 4:
							arr[index].gongyi.forEach(function(item1, index1) {
								item1.check = false;
								item1.num = '';
							})
							break;
						case 5:
							arr[index].gongyi[0].details.forEach(function(item1, index1) {
								item1.check = false;
							})
							arr[index].gongyi[1].check = false;
							arr[index].gongyi[1].num = '';
							break;
						case 6:
							arr[index].gongyi[0].details.forEach(function(item1, index1) {
								item1.check = false;
							})
							arr[index].gongyi[1].check = false;
							arr[index].gongyi[1].num = '';
							break;
						case 10:
							arr[index].num = '';
							break;
						case 11:
							arr[index].num = '';
							break;
					}
				}

				//查找可加工店铺
				function load_dian(id) {

					$.ajax({
						url: url + 'findgoods2',
						type: 'get',
						dataType: 'jsonp',
						jsonpCallback: 'successCallback2',
						async: false,
						data: {
							"id": id
						},
						success: function(data) {
							var str = "<option></option>";
							if(data.code == 200) {
								var list = data.data;
								str = "";
								for(var i = 0; i < list.length; i++) {
									if(list[i].sm_type == 1) {
										storeId_x[list[i].sm_storeid + ""] = {
											"tel": "",
											"address": "",
											"zd_id": stores[list[i].sm_storeid + ""]
										};
										str += '<option value=' + list[i].sm_storeid + '>自行加工</option>'
									} else {
										storeId_x[list[i].sm_multid + ""] = {
											"tel": list[i].store_phone,
											"address": list[i].store_address,
											"zd_id": list[i].zd_id
										};
										str += '<option value=' + list[i].sm_multid + '>' + list[i].s_name1 + '</option>'
									}
								}
								var definBtn = $("body").find(".definBtn");
								if(list[0].sm_type == 1) {
									for(var i = 0; i < definBtn.length; i++) {
										if($(definBtn[i]).attr("data-status") == 1) {
											$(definBtn[i]).hide();
										}
									}
								} else {
									for(var i = 0; i < definBtn.length; i++) {
										$(definBtn[i]).show();
									}
								}
								load_lensType(list[0].sm_multid);

							} else if(data.code == 201) {
								layer.msg("请先配置加工店铺");
							} else if(data.code == 400) {
								layer.msg("查询加工店铺失败")
							}
							$("#storeID").html(str);
							form.render();
							if($("#storeID").val()) {
								$("#address").html(storeId_x[$("#storeID").val() + ""]["address"]);
								$("#tel").html(storeId_x[$("#storeID").val() + ""]["tel"]);
								$("#save").show();
							} else {
								$("#save").hide();
							}

						}
					});
				}
				//查找选择店铺所对应的镜片类型
				function load_lensType(s_id) {
					var id = '{"code":"A11","accesstoken":"select * from tb_processconfig where store_id = ' + s_id + '  and pc_status=0 group BY pc_lensType"}';
					$.ajax({
						url: url + 'findgoods1',
						type: 'get',
						dataType: 'jsonp',
						jsonpCallback: 'successCallback',
						data: {
							"id": id
						},
						success: function(data) {
							var str = "";
							if(data.code == 200) {

								var list = data.data;

								for(var i = 0; i < list.length; i++) {
									if(i == 0) {
										load_gon(list[i].pc_lensName);
									}
									str += "<option value='" + list[i].pc_lensName + "'>" + list[i].pc_lensName + "</option>"
								}

							} else {
								layer.msg("请配置加工工艺");
							}
							$("#lensType").html(str);
							form.render();
						}
					});
				}

				//查找选择店铺所对应的镜片类型的加工工艺
				function load_gon(lensType) {

					arr = [{
							'name': '模型加工',
							'id': 'moxing',
							'gongyi': [{
									'type': '无框标准加工',
									'price': '-1',
									'check': false,
									'id': '20'
								},
								{
									'type': '半框标准加工',
									'price': '-1',
									'check': false,
									'id': '21'
								},
								{
									'type': '全框标准加工',
									'price': '-1',
									'check': false,
									'id': '22'
								}
							],
							'check': false
						},
						{
							'name': '钻孔',
							'price': '-1',
							'num': '',
							'check': false,
							'id': '1'
						},
						{
							'name': '倒边',
							'id': 'daobian',
							'gongyi': [{
									'type': '倒边A',
									'price': '-1',
									'check': false,
									'id': '2'
								},
								{
									'type': '倒边B',
									'price': '-1',
									'check': false,
									'id': '3'
								},
								{
									'type': '倒边C',
									'price': '-1',
									'check': false,
									'id': '4'
								}
							],
							'num': '',
							'check': false
						},
						{
							'name': '割边',
							'num': '',
							'price': '-1',
							'check': false,
							'id': '5'
						},
						{
							'name': '改型',
							'id': 'gaixing',
							'gongyi': [{
									'type': '左右改型',
									'num': '',
									'price': '-1',
									'check': false,
									'id': '6'
								},
								{
									'type': '上下改型',
									'num': '',
									'price': '-1',
									'check': false,
									'id': '7'
								}
							],
							'check': false
						},
						{
							'name': '染色单色',
							'id': 'randanse',
							'gongyi': [{
									'details': [

										{
											'type': '来色板',
											'price': '-1',
											'check': false,
											'id': '8'
										},
										{
											'type': '来色架',
											'price': '-1',
											'check': false,
											'id': '9'
										}
									]

								},
								{
									'type': '色度',
									'price': '-1',
									'check': false,
									'id': '10',
									'num': ''
								}
							],
							'check': false
						},
						{
							'name': '染色双色',
							'id': 'ranshuangse',
							'gongyi': [{
									'details': [

										{
											'type': '来色板',
											'price': '-1',
											'check': false,
											'id': '11'
										},
										{
											'type': '来色架',
											'price': '-1',
											'check': false,
											'id': '12'
										}
									]

								},
								{
									'type': '色度',
									'price': '-1',
									'num': '',
									'check': false,
									'id': '13'
								}
							],
							'check': false
						},
						{
							'name': '抛边',
							'price': '-1',
							'check': false,
							'id': '14'
						},
						{
							'name': '潜水镜',
							'price': '-1',
							'check': false,
							'id': '15'
						},
						{
							'name': '批花',
							'price': '-1',
							'check': false,
							'id': '16'
						},
						{
							'name': '倒角',
							'num': '',
							'price': '-1',
							'check': false,
							'id': '17'
						}, {
							'name': '特殊基弯',
							'num': '',
							'price': '-1',
							'check': false,
							'id': '18'
						},
						{
							'name': '投保费',
							'price': '-1',
							'check': false,
							'id': '19'
						}
					]

					var id = '{"code":"A11","accesstoken":"select * from tb_processconfig where store_id = ' + $("#storeID").val() + '  and pc_status=0 and pc_lensName=' + "'" + lensType + "'" + '"}';

					$.ajax({
						url: 'http://jingliyun.cn/jlyyj/index.php/Home/JavaInterface/findgoods2',
						type: 'get',
						dataType: 'jsonp',
						jsonpCallback: 'successCallback2',
						data: {
							"id": id
						},
						success: function(data) {
							if(data.code == 200) {
								var list = data.data;
								for(var o = 0; o < list.length; o++) {

									for(var i = 0; i < arr.length; i++) {
										var id_1 = arr[i]["id"]; //一级的ID
										if(id_1 == list[o].pc_processType) {
											arr[i]["price"] = list[o].pc_price;
											arr[i]["pc_id"] = list[o].pc_id;
											continue;
										} else {
											//进入第二级循环
											var gongyi_1 = arr[i]["gongyi"];
											if(gongyi_1) {
												for(var u = 0; u < gongyi_1.length; u++) {
													//定义、获取第二级参数
													var id_2 = gongyi_1[u]["id"];
													var num_2 = gongyi_1[u]["num"];
													var check_2 = arr[i]["gongyi"][u]["check"];
													if(id_2 == list[o].pc_processType) {
														arr[i]["gongyi"][u]["price"] = list[o].pc_price;
														arr[i]["gongyi"][u]["pc_id"] = list[o].pc_id;
														continue;
													} else {
														//进入第三级循环
														var details = gongyi_1[u]["details"];
														if(details) {
															for(var y = 0; y < details.length; y++) {
																//定义、获取第三级参数
																var id_3 = details[y]["id"];
																if(id_3 == list[o].pc_processType) {
																	arr[i]["gongyi"][u]["details"][y]["price"] = list[o].pc_price;
																	arr[i]["gongyi"][u]["details"][y]["pc_id"] = list[o].pc_id;
																	continue;
																}
															} //第三级循环结束
														}

													} //else2
												} //for2
											}

										} //else1
									}

								}

								goodsGongyiRender(arr)

							}

						},
						error: function(XMLHttpRequest, textStatus, errorThrown) {}
					});
				}

				function qing_gon() {

					arr = [{
							'name': '模型加工',
							'id': 'moxing',
							'gongyi': [{
									'type': '无框标准加工',
									'price': '-1',
									'check': false,
									'id': '20'
								},
								{
									'type': '半框标准加工',
									'price': '-1',
									'check': false,
									'id': '21'
								},
								{
									'type': '全框标准加工',
									'price': '-1',
									'check': false,
									'id': '22'
								}
							],
							'check': false
						},
						{
							'name': '钻孔',
							'price': '-1',
							'num': '',
							'check': false,
							'id': '1'
						},
						{
							'name': '倒边',
							'id': 'daobian',
							'gongyi': [{
									'type': '倒边A',
									'price': '-1',
									'check': false,
									'id': '2'
								},
								{
									'type': '倒边B',
									'price': '-1',
									'check': false,
									'id': '3'
								},
								{
									'type': '倒边C',
									'price': '-1',
									'check': false,
									'id': '4'
								}
							],
							'num': '',
							'check': false
						},
						{
							'name': '割边',
							'num': '',
							'price': '-1',
							'check': false,
							'id': '5'
						},
						{
							'name': '改型',
							'id': 'gaixing',
							'gongyi': [{
									'type': '左右改型',
									'num': '',
									'price': '-1',
									'check': false,
									'id': '6'
								},
								{
									'type': '上下改型',
									'num': '',
									'price': '-1',
									'check': false,
									'id': '7'
								}
							],
							'check': false
						},
						{
							'name': '染色单色',
							'id': 'randanse',
							'gongyi': [{
									'details': [

										{
											'type': '来色板',
											'price': '-1',
											'check': false,
											'id': '8'
										},
										{
											'type': '来色架',
											'price': '-1',
											'check': false,
											'id': '9'
										}
									]

								},
								{
									'type': '色度',
									'price': '-1',
									'check': false,
									'id': '10',
									'num': ''
								}
							],
							'check': false
						},
						{
							'name': '染色双色',
							'id': 'ranshuangse',
							'gongyi': [{
									'details': [

										{
											'type': '来色板',
											'price': '-1',
											'check': false,
											'id': '11'
										},
										{
											'type': '来色架',
											'price': '-1',
											'check': false,
											'id': '12'
										}
									]

								},
								{
									'type': '色度',
									'price': '-1',
									'num': '',
									'check': false,
									'id': '13'
								}
							],
							'check': false
						},
						{
							'name': '抛边',
							'price': '-1',
							'check': false,
							'id': '14'
						},
						{
							'name': '潜水镜',
							'price': '-1',
							'check': false,
							'id': '15'
						},
						{
							'name': '批花',
							'price': '-1',
							'check': false,
							'id': '16'
						},
						{
							'name': '倒角',
							'num': '',
							'price': '-1',
							'check': false,
							'id': '17'
						}, {
							'name': '特殊基弯',
							'num': '',
							'price': '-1',
							'check': false,
							'id': '18'
						},
						{
							'name': '投保费',
							'price': '-1',
							'check': false,
							'id': '19'
						}
					]

					goodsGongyiRender(arr)
					$("#lensType").html("<option></option>")
					form.render();
				}

				pd_ajax = 0;
				//选择店铺和选择镜片类型下拉框
				form.on("select", function(e) {
					if(!$(e)[0].value) {
						return;
					}
					if($(e)[0].elem.id == "storeID") {
						load_lensType($(e)[0].value)
						var definBtn = $("body").find(".definBtn");
						if($(e)[0].value == $("#sID").val()) {
							for(var i = 0; i < definBtn.length; i++) {
								if($(definBtn[i]).attr("data-status") == 1) {
									$(definBtn[i]).hide();
								}
							}
						} else {
							for(var i = 0; i < definBtn.length; i++) {
								$(definBtn[i]).show();
							}
						}

						if($(e)[0].value) {
							$("#address").html(storeId_x[$(e)[0].value + ""]["address"]);
							$("#tel").html(storeId_x[$(e)[0].value + ""]["tel"]);
							$("#save").show();
						} else {
							$("#save").hide();
						}
					} else if($(e)[0].elem.id == "lensType") {
						load_gon($(e)[0].value)
					} else if($(e)[0].elem.id == "sID") {
						var definBtn = $("body").find(".definBtn");
						for(var i = 0; i < definBtn.length; i++) {
							$(definBtn[i]).show();
						}
						var s_id = $("#sID").val();
						store_id = $("#sID").val();
						var ids_1 = '{"code":"A11","accesstoken":"SELECT a.*,b.store_name as s_name1,c.store_name as s_name2,b.store_address,b.store_phone,b.zd_id FROM tb_storemachining a left join tb_store b on a.sm_multid=b.store_id  left join tb_store c on a.sm_storeid=c.store_id where sm_status=0 and sm_storeid=' + s_id + '"}';
						qing_gon();
						load_dian(ids_1);
					}
				})
				//点击保存
				$("#save").on("click", function() {
					var imgs = $(".jingjiaChose").find(".checkJingjiaImg");
					var img = "";
					if(imgs.length > 0) {
						img = $(imgs).attr("name")
					}
					//定配单，SPH、CYL等数据获取
					var R_li = $("#R_dp").find("td");
					var L_li = $("#L_dp").find("td");
					var RL_LI = {};
					for(var i = 1; i < L_li.length; i++) {
						if($(L_li[i]).attr("id")) {
							RL_LI[$(L_li[i]).attr("id")] = $(L_li[i]).html();
							RL_LI[$(R_li[i]).attr("id")] = $(R_li[i]).html();
						}

					}
					//多焦点、远用、近用获取
					var jp_type = $(".userType").find(".userTypeCheck").attr("name");
					RL_LI["optometry_use"] = jp_type;

					var array = getArrDate();

					//镜架参数获取
					var gframe_canshu = [];
					gframe_canshu.push({
						"name": "gframe_type_img",
						"value": img
					});
					for(var i in jingjiaArgs) {
						if(i != "eyes") {
							gframe_canshu.push({
								"name": i,
								"value": jingjiaArgs[i]
							})
						}
					}

					var goodsArray = [];
					var eyesjson = {};
					var supplyjson = {};
					var gframe_price = 0;
					var lens_price = 0;
					for(var i in goodsAll) {
						if(goodsAll[i]["goods_id"] || goodsAll[i]["goods_id"] == 0) {
							goodsAll[i]["degree_id"] = goodsAll[i]["goods_id"];
							goodsAll[i]["counts"] = 1;
							var supply_i = $($("#" + i + "_supply").find(".check")).attr("data-status");
							supplyjson[goodsAll[i]["goods_id"] + ""] = supply_i;
							if(i == "L") {
								goodsAll[i]["eye_status"] = 1;
								if(supply_i == 1) {
									lens_price += goodsAll[i]["price"] / 1;
								}

								eyesjson[goodsAll[i]["goods_id"] + ""] = 1;
							} else if(i == "R") {
								goodsAll[i]["eye_status"] = 2;
								if(supply_i == 1) {
									lens_price += goodsAll[i]["price"] / 1;
								}
								eyesjson[goodsAll[i]["goods_id"] + ""] = 2;
							} else if(i == "F" && supply_i == 1) {
								gframe_price += goodsAll[i]["price"] / 1;
							}
							goodsArray.push(goodsAll[i]);
						}

					}

					if(goodsArray.length < 1) {
						layer.msg("请选择商品");
						return;
					}

					for(var i = 0; i < array.length; i++) {
						for(var o = 0; o < goodsArray.length; o++) {
							array[i]["degree_id"] = goodsArray[o]["degree_id"];
						}
					}
					if(array.length < 1) {
						layer.msg("请选择加工工艺");
						return;
					}

					var extract = 0;
					for(var o in supplyjson) {
						if(supplyjson[o] == 1) {
							extract = 1;
						}
					}

					//保存接口需要的值
					var save_json = {};
					save_json["optjson"] = RL_LI;
					save_json["ity_remark"] = $("#ity_remark").val();
					save_json["gframe_type_img"] = img;
					save_json["goodsArray"] = goodsArray;
					save_json["glasses_price"] = gframe_price / 1 + lens_price / 1;
					save_json["lens_price"] = lens_price;
					save_json["gframe_price"] = gframe_price;
					save_json["price"] = price["jiagong_price"] / 1 + gframe_price / 1 + lens_price / 1;
					save_json["array"] = array;
					save_json["gframe_canshu"] = gframe_canshu;
					save_json["eyesjson"] = eyesjson;
					save_json["supplyjson"] = supplyjson;
					save_json["source"] = 1;
					save_json["store_id2"] = $("#storeID").val();
					save_json["store_id1"] = store_id;
					save_json["user_id"] = user_id;
					save_json["extract"] = extract;
					console.log(save_json)

					if(pd_ajax == 1) {
						layer.msg("请勿重复点击")
						return;
					}
					pd_ajax = 1;

					var index = layer.load(1, {
						shade: [0.1, '#fff'] //0.1透明度的白色背景
					});
					$.ajax({
						url: 'http://jingliyun.cn/jlyyj/index.php/Home/JavaInterface/createProcess',
						type: 'get',
						dataType: 'jsonp',
						jsonpCallback: 'successCallback',
						data: {
							"id": JSON.stringify(save_json)
						},
						success: function(data) {
							layer.closeAll('loading');
							if(data.code == 200 || data.code == 201) {
								layer.msg("新建加工单成功");
								qing_div("L_xin")
								qing_div("R_xin")
								qing_div("F_xin")
								goodsAll = {
									"F": {},
									"L": {},
									"R": {}
								};
								qing_gon();
								var s_id = $("#sID").val();
								var ids_1 = '{"code":"A11","accesstoken":"SELECT a.*,b.store_name as s_name1,c.store_name as s_name2,b.store_address,b.store_phone,b.zd_id FROM tb_storemachining a left join tb_store b on a.sm_multid=b.store_id  left join tb_store c on a.sm_storeid=c.store_id where sm_status=0 and sm_storeid=' + s_id + '"}';
								load_dian(ids_1)
								var R_dp = $("#R_dp").find("td");
								var L_dp = $("#L_dp").find("td");
								for(var i = 1; i < R_dp.length; i++) {
									$(R_dp[i]).html("");
									$(L_dp[i]).html("");
								}
								var jingjiaArgs_s = $(".jingjiaArgs").find("input");
								for(var i = 0; i < jingjiaArgs_s.length; i++) {
									$(jingjiaArgs_s[i]).val("");
								}
								$("#ity_remark").val("");

								jingjiaArgs = {
									eyes: '0',
									gframe_EdgeThickness_R: '',
									gframe_CenterThickness_R: '',
									gframe_jiwan_R: '',
									gframe_jiwanMatch_R: '',
									gframe_thicknessMatch_R: '',
									gframe_aspect_R: '',
									gframe_EdgeThickness_L: '',
									gframe_CenterThickness_L: '',
									gframe_jiwan_R: '',
									gframe_jiwanMatch_L: '',
									gframe_thicknessMatch_L: '',
									gframe_aspect_L: ''
								}
								var definBtn_s = $(".definBtn");
								for(var i = 0; i < definBtn_s.length; i++) {
									$(definBtn_s[i]).removeClass("check")
								}

								$("#price").html("0");
							} else {
								layer.msg("新建加工失败");
							}
							pd_ajax = 0;
						},
						error: function() {
							layer.closeAll('loading');
							layer.msg("ajax异常");
							pd_ajax = 0;
						}
					});

				})

			})()

			//获取需要保存的工艺
			function getArrDate() {
				var array = [];
				var jiagong_price = 0;
				console.log(arr)
				for(var i = 0; i < arr.length; i++) {
					var id_1 = arr[i]["id"]; //一级的ID
					if(id_1 * 0 == 0) {
						var num_1 = arr[i]["num"]; //只有一层的输入值
						var check_1 = arr[i]["check"]; //只有一层的选择框
						var price_1 = arr[i]["price"];
						var pc_id_1 = arr[i]["pc_id"];
						if(num_1) {
							array.push({
								"pc_id": pc_id_1,
								"params": num_1
							});
							jiagong_price += price_1 / 1;
						} else if(check_1) {
							if(can_num[id_1] != 1) {
								array.push({
									"pc_id": pc_id_1,
									"params": ""
								});
								jiagong_price += price_1 / 1;
							}

						}
					} else {
						//进入第二级循环
						var gongyi_1 = arr[i]["gongyi"];
						for(var u = 0; u < gongyi_1.length; u++) {
							//定义、获取第二级参数
							var id_2 = gongyi_1[u]["id"];
							var num_2 = gongyi_1[u]["num"];
							var check_2 = gongyi_1[u]["check"];
							var price_2 = gongyi_1[u]["price"];
							var pc_id_2 = gongyi_1[u]["pc_id"];
							if(id_2 && id_2 * 0 == 0) {
								if(num_2) {
									array.push({
										"pc_id": pc_id_2,
										"params": num_2
									});
									jiagong_price += price_2 / 1;
								} else if(check_2) {
									if(can_num[id_2] != 1) {
										array.push({
											"pc_id": pc_id_2,
											"params": ""
										});
										jiagong_price += price_2 / 1;
									}

								}
							} else {
								//进入第三级循环
								var details = gongyi_1[u]["details"];
								for(var y = 0; y < details.length; y++) {
									//定义、获取第三级参数
									var id_3 = details[y]["id"];
									var num_3 = details[y]["num"]
									var check_3 = details[y]["check"]
									var price_3 = details[y]["price"]
									var pc_id_3 = details[y]["pc_id"]
									if(id_3) {
										if(num_3) {
											array.push({
												"pc_id": pc_id_3,
												"params": num_3
											});
											jiagong_price += price_3 / 1;
										} else if(check_3) {
											if(can_num[id_3] != 1) {
												array.push({
													"pc_id": pc_id_3,
													"params": ""
												});
												jiagong_price += price_3 / 1;
											}

										}

									}
								} //第三级循环结束
							} //else2
						} //for2
					} //else1
				}

				var gframe_price = 0;
				var lens_price = 0;
				for(var i in goodsAll) {
					var supply_i = $($("#" + i + "_supply").find(".check")).attr("data-status");
					if((goodsAll[i]["goods_id"] || goodsAll[i]["goods_id"] == 0) && supply_i == 1) {
						if(i == "L") {
							lens_price += goodsAll[i]["price"] / 1;
						} else if(i == "R") {
							lens_price += goodsAll[i]["price"] / 1;
						} else if(i == "F") {
							gframe_price += goodsAll[i]["price"] / 1;
						}

					}
				}
				price["goods_price"] = gframe_price / 1 + lens_price / 1;
				if(!price["goods_price"]) {
					price["goods_price"] = 0;
				}
				console.log(jiagong_price)
				$("#price").html(jiagong_price / 1 + price["goods_price"] / 1)
				price["jiagong_price"] = jiagong_price;

				return array;
			}

			function qing_div(id) {
				$("#" + id).find("img").attr("src", "http://jingliyun.cn/jlyyj/Public/img/ic_zhanwuphoto.png")
				$("#" + id).find("b").html("");
			}

			function set_goods(json) {

				if(!$("#sID").val() || !$("#storeID")) {
					layer.msg("请选择正确加工或发起方店铺");
					return;
				}

				if(json.get_status) {
					var get_status = json.get_status;
					switch(get_status / 1) {
						case 1:
							$("#R_supply").find("div[name=Rjiagong]").addClass("check");
							$("#R_supply").find("div[name=Rcenter]").removeClass("check");
							break;
						case 2:
							$("#R_supply").find("div[name=Rcenter]").addClass("check");
							$("#R_supply").find("div[name=Rjiagong]").removeClass("check");
							break;
						case 3:
							$("#L_supply").find("div[name=Ljiagong]").addClass("check");
							$("#L_supply").find("div[name=Lcenter]").removeClass("check");
							break;
						case 4:
							$("#L_supply").find("div[name=Lcenter]").addClass("check");
							$("#L_supply").find("div[name=Ljiagong]").removeClass("check");
							break;
						case 5:
							$("#F_supply").find("div[name=jingjiajiagong]").addClass("check");
							$("#F_supply").find("div[name=jingjiacenter]").removeClass("check");
							break;
						case 6:
							$("#F_supply").find("div[name=jingjiacenter]").addClass("check");
							$("#F_supply").find("div[name=jingjiajiagong]").removeClass("check");
							break;
						default:
							break;
					}

				}

				if(json.stock_imgPath) {
					if(json.eye == "F") {
						$("#" + json.eye + "_xin").find("img").attr("src", "http://cnc.jingliyun.com/pic/GlassesFrame/" + json.stock_imgPath);
					} else {
						$("#" + json.eye + "_xin").find("img").attr("src", "http://cnc.jingliyun.com/pic/GlassesLens/" + json.stock_imgPath);
					}

				} else {
					$("#" + json.eye + "_xin").find("img").attr("src", "http://jingliyun.cn/jlyyj/Public/img/ic_zhanwuphoto.png");
				}

				for(var i in json) {
					if(i == "degree_cyl") {
						var degree_cyl = json[i];
						if(degree_cyl) {
							$("#" + json.eye + "_xin").find("b[name=sph]").html(degree_cyl.split(",")[0]);
							$("#" + json.eye + "_xin").find("b[name=cyl]").html(degree_cyl.split(",")[1]);
						}
					} else {
						$("#" + json.eye + "_xin").find("b[name=" + i + "]").html(json[i]);
					}

				}
				getArrDate();
			}

			//获取随机数
			function suiji(n) {
				var rand = "";
				for(var i = 0; i < n; i++) {
					var r = Math.floor(Math.random() * 10);

					rand += r;

				}
				return rand;
			}
			//----------时间格式转换(把long型转换成yyyy-MM-dd格式)---------
			//----------------------------------------------------
			Date.prototype.Format = function(fmt) { //author: meizz
				var o = {
					"M+": this.getMonth() + 1, //月份
					"d+": this.getDate(), //日
					"H+": this.getHours(), //小时
					"m+": this.getMinutes(), //分
					"s+": this.getSeconds(), //秒
					"q+": Math.floor((this.getMonth() + 3) / 3), //季度
					"S": this.getMilliseconds() //毫秒
				};
				if(/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				for(var k in o)
					if(new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
				return fmt;
			}
			//--------------获取上个页面url ?后面的值------------------------
			//----------------------------------------------------
			function GetRequest() {
				var url = decodeURI(location.search); //获取url中"?"符后的字串
				var theRequest = new Object();
				if(url.indexOf("?") != -1) {
					var str = url.substr(1);
					strs = str.split("&");
					for(var i = 0; i < strs.length; i++) {
						theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
					}
				}
				return theRequest;
			}
		</script>
	</body>

</html>